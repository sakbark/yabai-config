#!/usr/bin/env sh

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# YABAI CONFIGURATION - STABLE MULTI-MONITOR SETUP (NO AUTO-RESTART)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "ğŸš€ Loading yabai configuration..."

# â”€â”€â”€ Scripting Addition Setup (Official) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
yabai -m signal --add event=dock_did_restart action="sudo yabai --load-sa"
sudo yabai --load-sa

# â”€â”€â”€ Display Change Handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Handle display changes gracefully by temporarily disabling auto-balance
# This prevents hanging when switching between single/multi-monitor setups
yabai -m signal --add event=display_added action="~/.config/yabai/handle-display-change.sh"
yabai -m signal --add event=display_removed action="~/.config/yabai/handle-display-change.sh"
yabai -m signal --add event=display_changed action="~/.config/yabai/handle-display-change.sh"

# â”€â”€â”€ Smart Event-Based Balancing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Balance only when windows are created or destroyed (not on every move/focus!)
# NOTE: window_moved was removed because it fires on EVERY focus change, causing lag
# Window creation handler: switches to space and focuses window for app assignments
yabai -m signal --add event=window_created action="~/.config/yabai/on-window-created.sh"
yabai -m signal --add event=window_destroyed action="yabai -m space --balance"

# â”€â”€â”€ Basic Layout Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
yabai -m config layout                 bsp
yabai -m config split_ratio            0.50
yabai -m config auto_balance           off
yabai -m config window_placement       second_child

# â”€â”€â”€ Visual Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
yabai -m config window_gap            6
yabai -m config top_padding           6
yabai -m config bottom_padding        6
yabai -m config left_padding          6
yabai -m config right_padding         6
yabai -m config window_shadow         on
yabai -m config window_opacity        off

# â”€â”€â”€ Mouse Behavior â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# NOTE: Having both focus_follows_mouse and mouse_follows_focus enabled
# creates a feedback loop that causes lag, especially with multiple monitors
yabai -m config focus_follows_mouse   autofocus
yabai -m config mouse_follows_focus   off
yabai -m config mouse_modifier        fn
yabai -m config mouse_action1         move
yabai -m config mouse_action2         resize

# â”€â”€â”€ Default Space for New Windows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
yabai -m config window_origin_display    default
yabai -m space 4 --label "Development"

# â”€â”€â”€ Simple Display Detection & Labeling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ¨ Labeling displays..."

# Get display count
DISPLAY_COUNT=$(yabai -m query --displays | jq length)
echo "ğŸ“Š Detected $DISPLAY_COUNT displays"

# Simple display labeling without complex logic
yabai -m display 1 --label "Main" 2>/dev/null || true
yabai -m display 2 --label "Secondary" 2>/dev/null || true  
yabai -m display 3 --label "Third" 2>/dev/null || true

# â”€â”€â”€ System Exclusions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ”§ Setting up system exclusions..."
yabai -m rule --add app=".*" manage=off subrole=AXSystemDialog
yabai -m rule --add app=".*" manage=off subrole=AXDialog
yabai -m rule --add app=".*" manage=off role=AXPopover

# â”€â”€â”€ App Space Assignments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ“± Setting up app assignments..."

# Space 1 - Productivity & Work Apps
yabai -m rule --add app="^Conduit$" space=1
yabai -m rule --add app="^Helpdesk  Pass the Keys$" space=1
yabai -m rule --add app="^Nfc Ideas$" space=1
yabai -m rule --add app="^Spark Desktop$" space=1
yabai -m rule --add app="^Todoist$" space=1

# Space 2 - Communication Apps
yabai -m rule --add app="^Google Chat$" space=2
yabai -m rule --add app="^Messages$" space=2
yabai -m rule --add app="^Messenger$" space=2
yabai -m rule --add app="^â€WhatsApp$" space=2

# Space 3 - Browser
yabai -m rule --add app="^Google Chrome$" space=3

# Space 4 - Development & System Tools
yabai -m rule --add app="^Reclaim$" space=4
yabai -m rule --add app="^Warp$" space=4
yabai -m rule --add app="^Home Assistant$" space=4
yabai -m rule --add app="^Loopback$" space=4

# â”€â”€â”€ Simple Display Assignments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ–¥ï¸  Setting up display assignments..."

# Only add display assignments if we have multiple displays
if [ "$DISPLAY_COUNT" -gt 1 ]; then
    # Put ChatMate on the third display (MacBook) if available
    if [ "$DISPLAY_COUNT" -ge 3 ]; then
        yabai -m rule --add app="^ChatMate Pro for WhatsApp$" display=3 2>/dev/null || true
    fi
    
    # Put Fantastical on secondary display if available
    yabai -m rule --add app="^Fantastical$" display=2 2>/dev/null || true
fi

# â”€â”€â”€ Floating & Sticky Apps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "âš™ï¸  Configuring floating and sticky apps..."

# Always floating and sticky
yabai -m rule --add app="^ChatGPT$" manage=off sticky=on grid=10:10:3:3:4:4
yabai -m rule --add app="^Bitwarden$" manage=off sticky=on
yabai -m rule --add app="^Google Meet$" manage=off sticky=on
yabai -m rule --add app="^System Settings$" manage=off sticky=on
yabai -m rule --add app="^iPhone Mirroring$" manage=off sticky=on
yabai -m rule --add app="^FaceTime$" manage=off sticky=on
yabai -m rule --add app="^Calculator$" manage=off

echo "âœ… Yabai configuration loaded successfully!"
echo "ğŸ“ Space assignments:"
echo "   ğŸ¯ Space 1: Productivity (Conduit, Helpdesk, Nfc Ideas, Spark, Todoist)"
echo "   ğŸ’¬ Space 2: Communication (Google Chat, Messages, Messenger, WhatsApp)" 
echo "   ğŸŒ Space 3: Browser (Google Chrome)"
echo "   âš¡ Space 4: Development (Reclaim, Warp, Home Assistant, Loopback)"
echo "ğŸ–¥ï¸ Display assignments:"
echo "   ğŸ“± ChatMate â†’ Third display (if available)"
echo "   ğŸ“… Fantastical â†’ Secondary display (if available)"
echo "ğŸˆ Floating/Sticky: ChatGPT, Bitwarden, Google Meet, System Settings, iPhone Mirroring"
